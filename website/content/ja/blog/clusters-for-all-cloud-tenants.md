---
title:  "すべてのクラウドテナント向けクラスター"
date:   2022-06-02 13:04:00 +0200
author: Josh Gavant
categories:
- Article
tags:
- WG Multi-tenancy
---

多くの大企業がクラウドアーキテクチャを採用する際に直面する課題は、同一環境・クラスター内で各チームや目的に応じた分離空間をどう提供するかです。例えば、マーケティングや営業向けアプリケーションは顧客向けアプリケーションから分離する必要があります。また、あらゆるアプリを開発するチームは通常、テストや検証用の追加スペースを必要とします。

## テナント単位としてのネームスペース

このニーズに対応するため、多くの組織が分離とテナント単位としてネームスペースの利用を開始しています。これは以前[Google](https://cloud.google.com/kubernetes-engine/docs/concepts/multitenancy-overview)や[Kubernetesコントリビューター](https://kubernetes.io/blog/2021/04/15/three-tenancy-models-for-kubernetes/)によって以前に説明されたパターンです。しかし、名前空間スコープの分離では不十分な場合が多くあります。なぜなら、一部の課題はクラスタースコープで管理されるからです。特に、新しいリソースタイプ（CRD）のインストールはクラスタースコープの活動であり、今日では独立したチームがカスタムリソースタイプやオペレータをインストールしたいと考えることがよくあります。また、より多くの開発者が自らソフトウェアオペレーターやカスタムリソースタイプを記述するようになり、研究やテストのためにクラスタースコープのアクセスが必要になるケースが増えています。

## テナント単位としてのクラスター

こうした理由から、テナントはしばしば制約のないアクセス権を持つ独自の分離されたクラスターを必要とします。分離されたクラスターでは、テナントは独自のKubernetes APIサーバーと永続化ストアを取得し、クラスター内のすべてのネームスペースとカスタムリソースタイプを完全に管理します。

しかし、多数のクラスター向けに物理マシンや仮想マシンをデプロイすることは非効率的で管理が困難なため、組織はテナントチームへのクラスター提供に苦労してきました。幸いなことに :smile:、こうした組織やユーザーのニーズに応えるため、主要なKubernetesベンダーは、組織のテナント向けに分離されたクラスターを提供する軽量なメカニズムの研究開発を進めています。本記事では、こうした新興の取り組みのいくつかを比較対照します。

クラウドアーキテクチャのマルチテナント性を強化する他のプロジェクトやアイデアをお持ちですか？ ぜひCNCFのApp Deliveryアドバイザリーグループに参加し、[こちら](https://github.com/cncf/tag-app-delivery/issues/193)で議論しましょう。よろしくお願いします！

### vcluster

[vcluster](https://www.vcluster.com/)は、[主要プロジェクト](https://www.google.com/search?q=vcluster&tbm=nws)であり、[loft.sh](https://loft.sh/)が管理するCLIツールです。テナントネームスペース内にStatefulSetとして仮想クラスターをプロビジョニングします。ホストネームスペースからのアクセス権限はホストされた仮想クラスターに継承され、当該ネームスペーステナントがクラスターの唯一のテナントとなります。クラスター管理者として、テナントメンバーはCRDやClusterRoleなどのクラスタースコープリソースを作成できます。

仮想クラスターは、ホストクラスターとは独立した独自のKubernetes APIサービスと永続化ストアを運用します。ホストクラスターからLoadBalancer型サービスとして公開され、kubectlやその他のKubernetes API準拠ツールで直接アクセス可能です。これにより、テナントクラスターの利用者はホストに関する知識がほとんど、あるいは全くなくても直接操作できます。

vclusterおよび以下のソリューションでは、仮想クラスターは「メタデータ専用」クラスターです。つまり、そのリソースはetcdのようなバックストアに永続化されますが、永続化されたリソース（最終的にはポッドとして）を具現化するスケジューラは動作しません。代わりに、「syncer」同期サービスが、仮想クラスターからホストクラスターのホストネームスペースへ、具現化可能なリソース（podspec）をコピーおよび変換します。ホストクラスタ内のスケジューラは、仮想クラスタのコントロールプレーンが動作する基盤となるテナントネームスペース内で、これらのリソースを検出し具現化します。

ホスティングネームスペースでのポッドスケジューリングというvclusterのアプローチの利点は、ホスティングクラスターが最終的に全てのワークロードを処理し、ネームスペースクォータを適用することです。全ての処理は、ホスティングクラスター管理者がテナントに割り当てたネームスペース内で発生します。欠点は、ポッドが実際に仮想クラスター上で実行されないため、スケジューラーを仮想クラスター内で設定できないことです。

- [vcluster on GitHub](https://github.com/loft-sh/vcluster)

### Cluster API Provider Nested (CAPN)

vclusterでは、コントロールプレーン実装に対する特注のサポートが必要です。執筆時点では、vclusterはk3s、k0s、およびvanilla k8sディストリビューションをサポートしています。

_あらゆる_制御プレーン実装をサポートするため、[Cluster API Provider Nested](https://github.com/kubernetes-sigs/cluster-api-provider-nested)プロジェクトはvclusterと同様のアーキテクチャ（メタデータ専用クラスターとシンカーを含む）を実装しつつ、専用ディストリビューションではなくCluster APIプロバイダーを用いて制御プレーンをプロビジョニングします。

CAPNは、Cluster API経由で実装可能なコントロールプレーンが仮想クラスターを提供することを可能にすると約束しています。

### HyperShift

前述の2つと同様に、[Red Hat](https://www.redhat.com/)の[HyperShift](https://github.com/openshift/hypershift)プロジェクトは、OpenShift（Red HatのKubernetesディストリビューション）のコントロールプレーンを、ホストネームスペース内のポッドの集合としてプロビジョニングします。しかしvclusterのようにホスティングクラスターとネームスペース内でワークロードを実行するのではなく、HyperShiftのコントロールプレーンは専用のワーカーノードプールに接続され、そこでポッドの同期とスケジューリングが行われます。

HyperShiftのモデルは、顧客からコントロールプレーン管理を抽象化し、ワーカーノードのみの管理を可能にしたいRed Hatのようなホスティングプロバイダーに最も適しているかもしれません。

### kcp

最後に、[kcp](https://github.com/kcp-dev/kcp)は[Red Hat](https://www.redhat.com/)による別の提案およびプロジェクトであり、これまでの全てのアイデアに触発され、再考されたものです。前述の仮想クラスターがホストクラスター_内部_で動作し、ポッドの実行・ネットワーク管理・ボリュームプロビジョニングをホストクラスターに依存するのに対し、kcpはこのパラダイムを逆転させ、_ホスティング_クラスターをメタデータ専用クラスターとします。_子_クラスター（kcpプロジェクトでは_ワークスペース_）はハブのメタデータ専用クラスターに登録され、ハブ内のリソースに付与されたラベルに基づいて作業がこれらの子クラスターに委譲されます。

ホスト型仮想クラスターとは異なり、kcpの子クラスターは_独自のスケジューラを管理できる可能性があります_。kcpのパラダイム反転によるもう一つの利点は、子クラスターの集中管理と可視化です。特にこれにより、カスタムリソースタイプ向けの簡素化された集中ポリシーや標準を全子クラスターに展開することが可能となります。

## 結論

vcluster、CAPN、HyperShift、kcpは、_クラスタ_をテナント単位とするマルチテナンシーに対するクラウドユーザーのニーズに応える新興プロジェクトおよび概念です。早期導入者からは既にこれらのアプローチの長所・改善点に関するフィードバックが寄せられており、新たなアイデアが日々生まれています。

クラウドマルチテナンシーの新たなアイデア推進にご協力いただけませんか？この分野で台頭するパラダイムについてクラウドユーザーが理解しフィードバックする手助けをしませんか？ぜひCNCFのTAG App Deliveryにおける[ディスカッション](https://github.com/cncf/tag-app-delivery/issues/193)にご参加ください。よろしくお願いします！
